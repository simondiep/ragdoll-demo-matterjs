<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.12.0/matter.min.js"></script>
<script type="text/javascript" src="./ragdoll.js"></script>
<script>
  let engine;
  let canvas;
  let context;
  let chest; // Focal point
  const renderWidth = 1200;
  const renderHeight = 600;

  // To bound the world coordinates
  const worldXMin = -10000;
  const worldXMax = 10000;
  const worldYMin = -1000;
  const worldYMax = 10000;

  // Store previous locations to indicate motion
  const lastPositions = [];
  const NUMBER_OF_LAST_POSITIONS = 10;

  window.onload = function () {
    canvas = document.createElement('canvas');
    context = canvas.getContext('2d');
    canvas.width = renderWidth;
    canvas.height = renderHeight;
    document.body.appendChild(canvas);

    // module aliases
    const { Bodies, Engine, Render, World } = Matter;
    // Matter.Resolver._restingThresh = 100;
    engine = Engine.create({
      gravity: { x: 0, y: 1 },
    });

    World.add(engine.world, [
      // ground
      Bodies.rectangle(worldXMin / 2, renderHeight + 250, worldXMax * 4, 250,
        {
          isStatic: true,
          render: {
            fillStyle: 'green'
          }
        }),
    ]);

    // create two boxes
    const boxA = Bodies.rectangle(400, 200, 80, 80);
    const boxB = Bodies.rectangle(450, 50, 80, 80);
    const boxToBoxConstraint = Matter.Constraint.create({
      bodyA: boxA,
      bodyB: boxB,
    });
    const boxes = Matter.Composite.create({
      bodies: [
        boxA, boxB,
      ],
      constraints: [
        boxToBoxConstraint,
      ]
    });

    // create ragdoll
    const ragdoll = createRagdoll(200, 400);

    // add all of the bodies to the world
    World.add(engine.world, [ragdoll, boxes]);

    Engine.run(engine);

    setInterval(render, 1000 / 60);
  }

  /**************************
   * Render functions start *
   **************************/

  function adjustCameraToPlayer() {
    function clamp(value, min, max) {
      if (value < min) return min;
      else if (value > max) return max;
      return value;
    }

    context.setTransform(1, 0, 0, 1, 0, 0);//reset the transform matrix as it is cumulative

    const playerCoordinates = {
      x: chest.vertices[0].x,
      y: chest.vertices[0].y,
    };
    const perceivedHeight = renderHeight - playerCoordinates.y;

    context.fillStyle = 'black';
    context.fillRect(0, 0, renderWidth, renderHeight);
    //Clamp the camera position to the world bounds while centering the camera around the player  
    var camX = clamp(-playerCoordinates.x + renderWidth / 2, worldXMin, worldXMax - renderWidth);
    var camY = clamp(-playerCoordinates.y + renderHeight * 3 / 5, worldYMin, worldYMax - renderHeight);

    context.translate(camX, camY);

    // Draw patterned background image
    const backgroundImage = document.getElementById("backgroundImage");
    const ptrn = context.createPattern(backgroundImage, 'repeat'); // Create a pattern with this image, and set it to "repeat".
    context.fillStyle = ptrn;
    context.fillRect(worldXMin, -worldYMax, worldXMax * 2, worldYMax*2);

    document.getElementById('xPosition').innerHTML = playerCoordinates.x.toFixed(0);
    document.getElementById('yPosition').innerHTML = perceivedHeight.toFixed(0);
  }

  // store last positions to indicate motion
  function storeLastPosition(xPos, yPos) {
    // push an item
    lastPositions.push({
      x: xPos,
      y: yPos
    });

    // get rid of first item
    if (lastPositions.length > NUMBER_OF_LAST_POSITIONS) {
      lastPositions.shift();
    }

    // get rid of duplicates/overlaps
    if (lastPositions.length > 1 && lastPositions[0].x === lastPositions[1].x && lastPositions[0].y === lastPositions[1].y) {
      lastPositions.shift();
    }
  }

  function render() {
    var bodies = Matter.Composite.allBodies(engine.world);

    adjustCameraToPlayer();

    // draw last positions as dot trail to indicate motion
    for (var i = 0; i < lastPositions.length; i++) {
      const ratio = (i + 1) / lastPositions.length;
      context.beginPath();
      context.arc(lastPositions[i].x, lastPositions[i].y, 20, 0, 2 * Math.PI, true);
      context.fillStyle = "rgba(224, 164, 35, " + ratio / 4 + ")";
      context.fill();
    }

    for (var i = 0; i < bodies.length; i += 1) {
      if (bodies[i].parts.length > 1) {
        for (let part of bodies[i].parts) {
          renderBodyPart(part);
        }
      } else {
        renderBodyPart(bodies[i]);
      }
    }
  }

  // Custom renderer
  function renderBodyPart(bodyPart) {
    if (bodyPart.label === "Body") {
      return;
    }
    var vertices = bodyPart.vertices;
    context.beginPath();
    context.moveTo(vertices[0].x, vertices[0].y);

    for (var j = 1; j < vertices.length; j += 1) {
      context.lineTo(vertices[j].x, vertices[j].y);
    }

    context.lineTo(vertices[0].x, vertices[0].y);
    context.closePath();
    context.fillStyle = bodyPart.render.fillStyle;
    context.fill();

    if (bodyPart.label === 'chest') {
      storeLastPosition(bodyPart.position.x, bodyPart.position.y);
    }
  }

  /**************************
   * Render functions end *
   **************************/
</script>
<div>Make the person fly by pressing qwop</div>
<div>
  <label>Distance</label>
  <label id="xPosition"></label>
</div>
<div>
  <label>Height</label>
  <label id="yPosition"></label>
</div>
<img id="backgroundImage" src="./clouds3.jpg" style="display:none" />